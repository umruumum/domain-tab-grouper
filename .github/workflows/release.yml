name: Release Chrome Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format v*.*.* (e.g., v1.0.0)"
            exit 1
          fi

      - name: Check manifest.json version
        run: |
          MANIFEST_VERSION=$(jq -r '.version' manifest.json)
          TAG_VERSION="${{ steps.version.outputs.version_number }}"
          
          echo "Manifest version: $MANIFEST_VERSION"
          echo "Tag version: $TAG_VERSION"
          
          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "Warning: manifest.json version ($MANIFEST_VERSION) does not match tag version ($TAG_VERSION)"
            echo "This is not an error, but consider updating manifest.json"
          fi

      - name: Create extension package
        run: |
          # Create temporary directory for extension files
          mkdir -p extension-package
          
          # Copy required files for Chrome extension
          cp manifest.json extension-package/
          cp background.js extension-package/
          cp popup.html extension-package/
          cp popup.js extension-package/
          
          # Copy icons if they exist
          if [ -d "icons" ]; then
            cp -r icons extension-package/
          fi
          
          # Create zip file
          cd extension-package
          zip -r "../domain-tab-grouper-${{ steps.version.outputs.version }}.zip" .
          cd ..
          
          echo "Package created: domain-tab-grouper-${{ steps.version.outputs.version }}.zip"
          ls -la *.zip

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create detailed Japanese release notes
          cat > release_notes.md << EOF
          ## ğŸ‰ Domain Tab Grouper $VERSION
          
          ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ã§ã‚¿ãƒ–ã‚’è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚
          
          ## âœ¨ ä¸»ãªæ©Ÿèƒ½
          
          ### ğŸ”„ è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
          - **åŠ¹ç‡çš„ã‚°ãƒ«ãƒ¼ãƒ—åŒ–**: åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚¿ãƒ–ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆã«è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
          - **è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—è§£é™¤**: ã‚°ãƒ«ãƒ¼ãƒ—ãŒ1ã¤ã®ã‚¿ãƒ–ã«ãªã£ãŸæ™‚ã«è‡ªå‹•è§£é™¤
          - **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œçŸ¥**: ã‚¿ãƒ–ä½œæˆãƒ»ãƒšãƒ¼ã‚¸é·ç§»ã‚’å³åº§ã«æ¤œçŸ¥
          - **ã‚¹ãƒãƒ¼ãƒˆç§»å‹•**: ãƒ‰ãƒ¡ã‚¤ãƒ³å¤‰æ›´æ™‚ã«é©åˆ‡ãªã‚°ãƒ«ãƒ¼ãƒ—ã¸è‡ªå‹•ç§»å‹•
          
          ### ğŸ¨ è¦–è¦šçš„ç®¡ç†
          - **è‰²åˆ†ã‘è¡¨ç¤º**: ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«ç•°ãªã‚‹è‰²ã§ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è­˜åˆ¥
          - **ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆ¥ç®¡ç†**: å„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ç‹¬ç«‹ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
          - **ã‚¯ãƒªãƒ¼ãƒ³UI**: ç›´æ„Ÿçš„ã§ä½¿ã„ã‚„ã™ã„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
          
          ### âš™ï¸ æŸ”è»Ÿãªåˆ¶å¾¡
          - **ON/OFFåˆ‡ã‚Šæ›¿ãˆ**: è‡ªå‹•ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®æœ‰åŠ¹ãƒ»ç„¡åŠ¹ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯
          - **æ‰‹å‹•æ“ä½œ**: ã„ã¤ã§ã‚‚æ‰‹å‹•ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒ»è§£é™¤ãŒå¯èƒ½
          - **é™¤å¤–ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š**: ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‹ã‚‰é™¤å¤–ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å¯¾å¿œï¼‰
          - **è¨­å®šæ°¸ç¶šåŒ–**: è¨­å®šã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã€å†èµ·å‹•å¾Œã‚‚ç¶­æŒ
          
          ## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          
          1. \`domain-tab-grouper-$VERSION.zip\` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡
          3. Chromeã§æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿:
             - \`chrome://extensions/\` ã‚’é–‹ã
             - ã€Œãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æœ‰åŠ¹åŒ–
             - ã€Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
          
          ## ğŸš€ ä½¿ç”¨ä¾‹
          
          \`\`\`
          ä¾‹: google.com ã®ã‚¿ãƒ–ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆ
          â†’ ã€Œgoogle.comã€ã¨ã„ã†åå‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒè‡ªå‹•ä½œæˆã•ã‚Œã‚‹
          
          ä¾‹: å˜ä¸€ã®ã‚¿ãƒ–ã®å ´åˆ
          â†’ ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã›ãšã«é€šå¸¸ã®ã‚¿ãƒ–ã®ã¾ã¾
          
          ä¾‹: ã‚°ãƒ«ãƒ¼ãƒ—ãŒ1ã¤ã®ã‚¿ãƒ–ã«ãªã£ãŸå ´åˆ
          â†’ è‡ªå‹•çš„ã«ã‚°ãƒ«ãƒ¼ãƒ—ãŒè§£é™¤ã•ã‚Œã€é€šå¸¸ã®ã‚¿ãƒ–ã«æˆ»ã‚‹
          
          ä¾‹: é™¤å¤–ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
          â†’ "example.com" ã¾ãŸã¯ "*.example.com" ã‚’è¿½åŠ 
          â†’ è©²å½“ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œãªããªã‚‹
          \`\`\`
          
          ## ğŸ› ï¸ æŠ€è¡“ä»•æ§˜
          
          - **Manifest Version**: 3.0
          - **å¿…è¦ãªæ¨©é™**: \`tabs\`, \`tabGroups\`, \`activeTab\`, \`storage\`
          - **å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶**: Chromeï¼ˆChromiumç³»ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚å‹•ä½œå¯èƒ½ï¼‰
          
          ---
          
          <div align="center">
          Made with â¤ï¸ for better browsing experience
          </div>
          EOF
          
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Domain Tab Grouper ${{ steps.version.outputs.version }}"
          body_path: ${{ steps.release_notes.outputs.release_notes_file }}
          files: |
            domain-tab-grouper-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
          generate_release_notes: false

      - name: Release Summary
        run: |
          echo "ğŸ‰ Release created successfully!"
          echo "ğŸ“¦ Package: domain-tab-grouper-${{ steps.version.outputs.version }}.zip"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"